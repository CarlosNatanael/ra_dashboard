{% extends "layout.html" %}

{% block title %}
    Admin - RA Dashboard
{% endblock %}

{% block content %}
    <h2>Painel de Admin (Visão do Revisor)</h2>
    
    <h3>Adicionar Novo Pedido à Fila</h3>
    <form action="/admin/add" method="post">
        <label for="game_id">Game ID:</label>
        <input type="number" id="game_id" name="game_id" required onblur="fetchGameName()">
        
        <label for="game_name">Nome do Jogo:</label>
        <input type="text" id="game_name" name="game_name" required>
        
        <label for="developer_username">Dev (Username):</label>
        <input type="text" id="developer_username" name="developer_username" required>
        
        <button type="submit">Adicionar à Fila</button>
    </form>
    <hr>

    <h3>Fila de Revisão Atual</h3>
    <table>
        <thead>
            <tr>
                <th>Jogo</th>
                <th>Desenvolvedor</th>
                <th>Status</th>
                <th>Revisor</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for item in queue %}
                <tr>
                    <td>
                        <a href="https://retroachievements.org/game/{{ item['game_id'] }}" target="_blank">
                            {{ item['game_name'] }} ({{ item['game_id'] }})
                        </a>
                    </td>
                    <td>{{ item['developer_username'] }}</td>
                    
                    <form action="/admin/update/{{ item['id'] }}" method="post" style="margin:0;">
                        <td>
                            <select name="status">
                                <option value="Pending" {% if item['status'] == 'Pending' %}selected{% endif %}>Pending</option>
                                <option value="In_Discussion" {% if item['status'] == 'In_Discussion' %}selected{% endif %}>In Discussion</option>
                                <option value="In_Review" {% if item['status'] == 'In_Review' %}selected{% endif %}>In Review</option>
                                <option value="Approved" {% if item['status'] == 'Approved' %}selected{% endif %}>Approved</option>
                            </select>
                        </td>
                        <td>
                            <strong>{{ item['reviewer_username'] or 'N/A' }}</strong>
                        </td>
                        <td>
                            <button type="submit" name="action" value="update_status">Atualizar Status</button>
                            
                            <button type="submit" name="action" value="claim_set">Assinar Set</button>
                            
                            <a href="/admin/delete/{{ item['id'] }}" class="button delete" onclick="return confirm('Tem certeza?');">Deletar</a>
                        </td>
                    </form>
                </tr>
            {% endfor %}
        </tbody>
    </table>
{% endblock %}
{% block content %}
    <script>
        function fetchGameName() {
            const gameIdInput = document.getElementById('game_id');
            const gameNameInput = document.getElementById('game_name');
            const gameId = gameIdInput.value;

            if (!gameId) {
                return;
            }

            gameNameInput.value = "Carregando...";

            fetch(`/api/get-game-name/${gameId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Jogo não encontrado ou erro de API');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.game_name) {
                        gameNameInput.value = data.game_name;
                    } else {
                        gameNameInput.value = "Erro: Jogo não encontrado";
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    gameNameInput.value = "Erro ao buscar";
                });
        }
    </script>
{% endblock %}